x-common-volumes: &common-volumes
  music-volume: &music-volume "${MUSIC_PATH:-/media/s/be3654b3-8643-4a6e-9477-68327cc11ff5/Music/0 curations and encodes/Jolist/71mix}:/music:ro"

services:
  app:
    build:
      context: .
      dockerfile_inline: |
        FROM alpine:3.19
        WORKDIR /app
        RUN apk add --no-cache vim \
            ffmpeg \
            nodejs \
            npm
        # Copy package files
        COPY package*.json ./
        # Install ALL dependencies (including devDependencies for build)
        RUN npm ci
        # Copy source and build
        COPY . .
        RUN npm run build
        RUN npm run build:server


        # Clean up dev dependencies after build
        #RUN npm prune --production
        
        # doesn't know socket.io???
        # CMD ["node", "build"]
        # CMD ["node", "server.js"]
        CMD ["node", "dist-server/server.js"]
    container_name: jamsend-prod
    working_dir: /app
    volumes:
      # - "./testsounds:/music:ro"
      - ".svelte-kit/:/app/.svelte-kit/"
      - *music-volume
    ports:
      # this would bind to LAN address as well
      #  but WebRTC requires a secure context (can be localhost)
      # - "9091:9091"
      - "172.17.0.1:19091:19091"
    environment:
      - PORT=19091
      - HOST=0.0.0.0
    tty: true
    stdin_open: true
    restart: 'always'


    # Resource limits to prevent runaway processes
    deploy:
      resources:
        limits:
          cpus: '2'          # Max 2 CPU cores
          memory: 1.5G           # Max 1GB RAM
        reservations:
          cpus: '0.5'          # Reserve 0.5 CPU cores  
          memory: 256M         # Reserve 256MB RAM
    # Process limits
    ulimits:
      nproc: 100               # Max 100 processes total
      nofile: 1024             # Max 1024 open files

